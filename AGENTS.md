<!-- Generated by Ruler -->

<!-- Source: .ruler/common/commitMessages.md -->

# Commit Messages

Follow Conventional Commits 1.0 spec for commit messages and PR titles.

<!-- Source: .ruler/common/configuration.md -->

# Configuration

```text
Contains secrets?
  └── Yes → SSM Parameter Store
  └── No → Engineers-only, tolerate 1hr propagation?
      └── Yes → Hardcode with @clipboard-health/config
      └── No → 1:1 with DB entity OR needs custom UI?
          └── Yes → Database
          └── No → LaunchDarkly feature flag
```

<!-- Source: .ruler/common/featureFlags.md -->

# Feature Flags

**Naming:** `YYYY-MM-[kind]-[subject]` (e.g., `2024-03-release-new-booking-flow`)

| Kind         | Purpose                  |
| ------------ | ------------------------ |
| `release`    | Gradual rollout to 100%  |
| `enable`     | Kill switch              |
| `experiment` | Trial for small audience |
| `configure`  | Runtime config           |

**Rules:**

- "Off" = default/safer value
- No permanent flags (except `configure`)
- Create archival ticket when creating flag
- Validate staging before production
- Always provide default values in code
- Clean up after full launch

<!-- Source: .ruler/common/loggingObservability.md -->

# Logging & Observability

## Log Levels

| Level | When                                       |
| ----- | ------------------------------------------ |
| ERROR | Required functionality broken (2am pager?) |
| WARN  | Optional broken OR recovered from failure  |
| INFO  | Informative, ignorable during normal ops   |
| DEBUG | Local only, not production                 |

## Best Practices

```typescript
// Bad
logger.error("Operation failed");
logger.error(`Operation failed for workplace ${workplaceId}`);

// Good—structured context
logger.error("Exporting urgent shifts to CSV failed", {
  workplaceId,
  startDate,
  endDate,
});
```

**Never log:** PII, PHI, tokens, secrets, SSN, account numbers, entire request/response/headers.

Use metrics for counting:

```typescript
datadogMetrics.increment("negotiation.errors", { state: "New York" });
```

<!-- Source: .ruler/common/pullRequests.md -->

# Pull Requests

**Requirements:**

1. Clear title: change summary + ticket; Conventional Commits 1.0
2. Thorough description: why, not just what
3. Small & focused: single concept
4. Tested: service tests + validation proof
5. Passing CI

**Description:** Link ticket, context, reasoning, areas of concern.

<!-- Source: .ruler/common/security.md -->

# Security

**Secrets:**

- `.env` locally (gitignored)
- Production: AWS SSM Parameter Store
- Prefer short-lived tokens

**Naming:** `[ENV]_[VENDOR]_[TYPE]_usedBy_[CLIENT]_[SCOPE]_[CREATED_AT]_[OWNER]`

<!-- Source: .ruler/common/structuredConcurrency.md -->

# Structured Concurrency

```typescript
// Cancellation propagation
async function fetchWithTimeout(url: string, timeoutMs: number): Promise<Response> {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
  try {
    return await fetch(url, { signal: controller.signal });
  } finally {
    clearTimeout(timeoutId);
  }
}

// All results regardless of failures
const results = await Promise.allSettled(operations);
const succeeded = results.filter((r) => r.status === "fulfilled");
const failed = results.filter((r) => r.status === "rejected");
```

<!-- Source: .ruler/common/testing.md -->

# Testing

## Unit Tests

Use when: error handling hard to trigger black-box, concurrency scenarios, >5 variations, pure function logic.

## Conventions

- Use `it` not `test`; `describe` for grouping
- Arrange-Act-Assert with newlines between
- Variables: `mockX`, `input`, `expected`, `actual`
- Prefer `it.each` for multiple cases
- No conditional logic in tests

<!-- Source: .ruler/common/typeScript.md -->

# TypeScript

## Naming Conventions

| Element               | Convention            | Example                      |
| --------------------- | --------------------- | ---------------------------- |
| File-scope constants  | UPPER_SNAKE_CASE      | `MAX_RETRY_COUNT`            |
| Acronyms in camelCase | Lowercase after first | `httpRequest`, `gpsPosition` |
| Files                 | Singular, dotted      | `user.service.ts`            |

## Core Rules

- Strict-mode TypeScript; prefer interfaces over types
- Avoid enums—use const maps
- NEVER use `any`—use `unknown` or generics
- Avoid type assertions (`as`, `!`) unless absolutely necessary
- Use `function` keyword for declarations, not `const`
- Prefer `undefined` over `null`
- Explicit return types on functions
- Files read top-to-bottom: exports first, internal helpers below
- Boolean props: `is*`, `has*`, `should*`, `can*`
- Use const assertions for constants: `as const`

## Types

```typescript
// Strong typing
function process(arg: unknown) {} // Better than any
function process<T>(arg: T) {} // Best

// Nullable checks
if (foo == null) {
} // Clear intent
if (isDefined(foo)) {
} // Better with utility

// Quantity values—always unambiguous
const money = { amountInMinorUnits: 500, currencyCode: "USD" };
const durationMinutes = 30;
```

**Type Techniques:**

- Union, intersection, conditional types for complex definitions
- Mapped types: `Partial<T>`, `Pick<T>`, `Omit<T>`
- `keyof`, index access types, discriminated unions
- `as const`, `typeof`, `instanceof`, `satisfies`, type guards
- Exhaustiveness checking with `never`
- `readonly` for parameter immutability

## Functions

```typescript
// Object arguments with interfaces
interface CreateUserRequest {
  email: string;
  name?: string;
}

function createUser(request: CreateUserRequest): User {
  const { email, name } = request; // Destructure inside
  // ...
}

// Guard clauses for early returns
function processOrder(order: Order): Result {
  if (!order.isValid) {
    return { error: "Invalid order" };
  }
  // Main logic
}
```

## Objects & Arrays

```typescript
// Spread over Object.assign
const updated = { ...original, name: "New Name" };

// Array methods over loops (unless breaking early)
const doubled = items.map((item) => item * 2);
const sorted = items.toSorted((a, b) => a - b); // Immutable

// For early exit
for (const item of items) {
  if (condition) break;
}
```

## Async

```typescript
// async/await over .then()
async function fetchData(): Promise<Data> {
  const response = await api.get("/data");
  return response.data;
}

// Parallel
const results = await Promise.all(items.map(processItem));

// Sequential (when needed)
for (const item of items) {
  // eslint-disable-next-line no-await-in-loop
  await processItem(item);
}
```

## Classes

```typescript
class UserService {
  public async findById(request: FindByIdRequest): Promise<User> {}
  private validateUser(user: User): boolean {}
}

// Extract pure functions outside classes
function formatUserName(first: string, last: string): string {
  return `${first} ${last}`;
}
```

<!-- Source: ./OVERLAY.md -->

# Architecture

This is an Nx monorepo containing TypeScript libraries and utilities for Clipboard Health. The codebase follows functional programming patterns with strict TypeScript and emphasizes type safety, immutability, and pure functions.

## Key Libraries

- **util-ts**: Core TypeScript utilities including `ServiceResult` (Either type), `ServiceError`, functional utilities (`pipe`, `option`, `either`)
- **testing-core**: Testing utilities and helpers
- **nx-plugin**: Custom Nx generators for project management

# Commands

## Development

```bash
# Install dependencies
npm install

# Build, lint, and test only changed files from main
npm run affected

# Build, lint, and test everything
npm run all

# Format code
npm run format

# Check formatting, spelling, and run embedex
npm run ci:check
```

## Package-specific Commands

```bash
# Install dependency in specific package
npm install --workspace packages/[PROJECT_NAME] [DEPENDENCY]

# Run specific command against a package
npx nx run [PROJECT_NAME]:[COMMAND]

# Common targets: build, lint, test
npx nx run json-api:build
npx nx run util-ts:test

# For test coverage, run with the "ci" configuration
npx nx run util-ts:test:ci
```

# Project Structure

Each package in `packages/` has:

- `project.json`: Nx project configuration with build/lint/test targets
- `src/index.ts`: Main export file
- `README.md`: Package-specific documentation with usage examples
- Individual `tsconfig.lib.json`, `jest.config.ts`, etc.

# Development Notes

- The repo uses conventional commits with automated releases
- Code must pass lint, typecheck, and tests before commits
- Use `npm run affected` before opening PRs to verify changes

<!-- nx configuration start-->
<!-- Leave the start & end comments to automatically receive updates. -->

# General Guidelines for working with Nx

- When running tasks (for example build, lint, test, e2e, etc.), always prefer running the task through `nx` (i.e. `nx run`, `nx run-many`, `nx affected`) instead of using the underlying tooling directly
- You have access to the Nx MCP server and its tools, use them to help the user
- When answering questions about the repository, use the `nx_workspace` tool first to gain an understanding of the workspace architecture where applicable.
- When working in individual projects, use the `nx_project_details` mcp tool to analyze and understand the specific project structure and dependencies
- For questions around nx configuration, best practices or if you're unsure, use the `nx_docs` tool to get relevant, up-to-date docs. Always use this instead of assuming things about nx configuration
- If the user needs help with an Nx configuration or project graph error, use the `nx_workspace` tool to get any errors

<!-- nx configuration end-->
