<!DOCTYPE html><html class="default" lang="en" data-base="../"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@clipboard-health/mongo-jobs - v1.2.12 | core-utils</title><meta name="description" content="Documentation for core-utils"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="../index.html" class="title">core-utils</a><div id="tsd-toolbar-links"></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb" aria-label="Breadcrumb"><li><a href="" aria-current="page">@clipboard-health/mongo-jobs</a></li></ul><h1>Module @clipboard-health/mongo-jobs - v1.2.12</h1></div><section class="tsd-panel tsd-typography"><h1 id="clipboard-healthmongo-jobs" class="tsd-anchor-link">@clipboard-health/mongo-jobs<a href="#clipboard-healthmongo-jobs" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><blockquote>
<p>A robust, MongoDB-backed background job processing library for Node.js with TypeScript support</p>
</blockquote>
<h2 id="features" class="tsd-anchor-link">Features<a href="#features" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li><strong>Reliable job processing</strong> - Built on MongoDB for persistent, reliable job storage</li>
<li><strong>Automatic retries</strong> - Exponential backoff with configurable max attempts</li>
<li><strong>Delayed jobs</strong> - Schedule jobs to run at specific times</li>
<li><strong>Unique jobs</strong> - Ensure only one instance of a job is enqueued or running</li>
<li><strong>Cron scheduling</strong> - Built-in support for recurring jobs with cron expressions</li>
<li><strong>Job groups</strong> - Organize jobs into groups and run dedicated workers per group</li>
<li><strong>Transaction support</strong> - Enqueue jobs atomically with MongoDB sessions</li>
<li><strong>Type-safe</strong> - Full TypeScript support with strongly-typed job payloads</li>
<li><strong>Concurrency control</strong> - Configure worker concurrency per group</li>
<li><strong>Observability</strong> - Built-in metrics reporting and logging support</li>
</ul>
<h2 id="installation" class="tsd-anchor-link">Installation<a href="#installation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="bash"><span class="hl-1">npm</span><span class="hl-2"> </span><span class="hl-3">install</span><span class="hl-2"> </span><span class="hl-3">@clipboard-health/mongo-jobs</span>
</code><button type="button">Copy</button></pre>

<h2 id="quick-start" class="tsd-anchor-link">Quick Start<a href="#quick-start" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="1-define-a-job-handler" class="tsd-anchor-link">1. Define a job handler<a href="#1-define-a-job-handler" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Job handlers implement the <code>HandlerInterface</code> and define how your jobs are processed:</p>
<embedex source="packages/mongo-jobs/examples/quickstart/welcomeEmailJob.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> </span><span class="hl-8">type</span><span class="hl-2"> { </span><span class="hl-6">HandlerInterface</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;@clipboard-health/mongo-jobs&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-8">export</span><span class="hl-2"> </span><span class="hl-4">interface</span><span class="hl-2"> </span><span class="hl-10">WelcomeEmailData</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">userId</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">;</span><br/><span class="hl-2">  </span><span class="hl-6">email</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">;</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-8">export</span><span class="hl-2"> </span><span class="hl-4">class</span><span class="hl-2"> </span><span class="hl-10">WelcomeEmailJob</span><span class="hl-2"> </span><span class="hl-4">implements</span><span class="hl-2"> </span><span class="hl-10">HandlerInterface</span><span class="hl-2">&lt;</span><span class="hl-10">WelcomeEmailData</span><span class="hl-2">&gt; {</span><br/><span class="hl-2">  </span><span class="hl-4">public</span><span class="hl-2"> </span><span class="hl-6">name</span><span class="hl-2"> = </span><span class="hl-3">&quot;WelcomeEmailJob&quot;</span><span class="hl-2">;</span><br/><span class="hl-2">  </span><span class="hl-4">public</span><span class="hl-2"> </span><span class="hl-6">maxAttempts</span><span class="hl-2"> = </span><span class="hl-11">3</span><span class="hl-2">;</span><br/><br/><span class="hl-2">  </span><span class="hl-4">async</span><span class="hl-2"> </span><span class="hl-1">perform</span><span class="hl-2">({ </span><span class="hl-6">userId</span><span class="hl-2">, </span><span class="hl-6">email</span><span class="hl-2"> }: </span><span class="hl-10">WelcomeEmailData</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-4">this</span><span class="hl-2">.</span><span class="hl-1">sendEmail</span><span class="hl-2">(</span><span class="hl-6">email</span><span class="hl-2">, </span><span class="hl-3">`Welcome, user </span><span class="hl-4">${</span><span class="hl-6">userId</span><span class="hl-4">}</span><span class="hl-3">!`</span><span class="hl-2">);</span><br/><span class="hl-2">  }</span><br/><br/><span class="hl-2">  </span><span class="hl-4">private</span><span class="hl-2"> </span><span class="hl-4">async</span><span class="hl-2"> </span><span class="hl-1">sendEmail</span><span class="hl-2">(</span><span class="hl-6">_to</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">, </span><span class="hl-6">_message</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-0">// Email sending logic</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

</embedex>
<h3 id="2-create-a-service-and-register-handlers" class="tsd-anchor-link">2. Create a service and register handlers<a href="#2-create-a-service-and-register-handlers" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Create a <code>BackgroundJobs</code> instance and register your handlers to groups:</p>
<embedex source="packages/mongo-jobs/examples/quickstart/jobsRegistry.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">BackgroundJobs</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;@clipboard-health/mongo-jobs&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">WelcomeEmailJob</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./welcomeEmailJob&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-4">const</span><span class="hl-2"> </span><span class="hl-9">backgroundJobs</span><span class="hl-2"> = </span><span class="hl-4">new</span><span class="hl-2"> </span><span class="hl-1">BackgroundJobs</span><span class="hl-2">();</span><br/><br/><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">register</span><span class="hl-2">(</span><span class="hl-6">WelcomeEmailJob</span><span class="hl-2">, </span><span class="hl-3">&quot;emails&quot;</span><span class="hl-2">);</span><br/><br/><span class="hl-8">export</span><span class="hl-2"> { </span><span class="hl-6">backgroundJobs</span><span class="hl-2"> };</span>
</code><button type="button">Copy</button></pre>

</embedex>
<h3 id="3-enqueue-jobs" class="tsd-anchor-link">3. Enqueue jobs<a href="#3-enqueue-jobs" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Add jobs to the queue to be processed:</p>
<embedex source="packages/mongo-jobs/examples/quickstart/enqueueJob.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">backgroundJobs</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobsRegistry&quot;</span><span class="hl-2">;</span><br/><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">WelcomeEmailJob</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./welcomeEmailJob&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">enqueue</span><span class="hl-2">(</span><span class="hl-6">WelcomeEmailJob</span><span class="hl-2">, {</span><br/><span class="hl-2">  </span><span class="hl-6">userId:</span><span class="hl-2"> </span><span class="hl-3">&quot;123&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">email:</span><span class="hl-2"> </span><span class="hl-3">&quot;user@example.com&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

</embedex>
<h3 id="4-start-the-worker" class="tsd-anchor-link">4. Start the worker<a href="#4-start-the-worker" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Start processing jobs from the queue:</p>
<embedex source="packages/mongo-jobs/examples/quickstart/startWorker.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">backgroundJobs</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobsRegistry&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">start</span><span class="hl-2">([</span><span class="hl-3">&quot;emails&quot;</span><span class="hl-2">], {</span><br/><span class="hl-2">  </span><span class="hl-6">maxConcurrency:</span><span class="hl-2"> </span><span class="hl-11">10</span><span class="hl-2">,</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

</embedex>
<h2 id="usage" class="tsd-anchor-link">Usage<a href="#usage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="creating-a-job" class="tsd-anchor-link">Creating a job<a href="#creating-a-job" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Jobs are defined as classes that implement the <code>HandlerInterface</code>:</p>
<embedex source="packages/mongo-jobs/examples/usage/myJob.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> </span><span class="hl-8">type</span><span class="hl-2"> { </span><span class="hl-6">BackgroundJobType</span><span class="hl-2">, </span><span class="hl-6">HandlerInterface</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;@clipboard-health/mongo-jobs&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-8">export</span><span class="hl-2"> </span><span class="hl-4">interface</span><span class="hl-2"> </span><span class="hl-10">MyJobData</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">userId</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">;</span><br/><span class="hl-2">  </span><span class="hl-6">action</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">;</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-8">export</span><span class="hl-2"> </span><span class="hl-4">class</span><span class="hl-2"> </span><span class="hl-10">MyJob</span><span class="hl-2"> </span><span class="hl-4">implements</span><span class="hl-2"> </span><span class="hl-10">HandlerInterface</span><span class="hl-2">&lt;</span><span class="hl-10">MyJobData</span><span class="hl-2">&gt; {</span><br/><span class="hl-2">  </span><span class="hl-0">// Required: unique name for this job type</span><br/><span class="hl-2">  </span><span class="hl-4">public</span><span class="hl-2"> </span><span class="hl-6">name</span><span class="hl-2"> = </span><span class="hl-3">&quot;MyJob&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-2">  </span><span class="hl-0">// Optional: max retry attempts (default: 10)</span><br/><span class="hl-2">  </span><span class="hl-4">public</span><span class="hl-2"> </span><span class="hl-6">maxAttempts</span><span class="hl-2"> = </span><span class="hl-11">5</span><span class="hl-2">;</span><br/><br/><span class="hl-2">  </span><span class="hl-0">// Required: the actual job logic</span><br/><span class="hl-2">  </span><span class="hl-4">async</span><span class="hl-2"> </span><span class="hl-1">perform</span><span class="hl-2">(</span><span class="hl-6">data</span><span class="hl-2">: </span><span class="hl-10">MyJobData</span><span class="hl-2">, </span><span class="hl-6">job</span><span class="hl-2">?: </span><span class="hl-10">BackgroundJobType</span><span class="hl-2">&lt;</span><span class="hl-10">MyJobData</span><span class="hl-2">&gt;) {</span><br/><span class="hl-2">    </span><span class="hl-0">// Job implementation</span><br/><span class="hl-2">    </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-3">`Processing </span><span class="hl-4">${</span><span class="hl-6">data</span><span class="hl-13">.</span><span class="hl-6">action</span><span class="hl-4">}</span><span class="hl-3"> for user </span><span class="hl-4">${</span><span class="hl-6">data</span><span class="hl-13">.</span><span class="hl-6">userId</span><span class="hl-4">}</span><span class="hl-3">`</span><span class="hl-2">);</span><br/><br/><span class="hl-2">    </span><span class="hl-0">// Optional: access job metadata</span><br/><span class="hl-2">    </span><span class="hl-8">if</span><span class="hl-2"> (</span><span class="hl-6">job</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-3">`Job ID: </span><span class="hl-4">${</span><span class="hl-6">job</span><span class="hl-13">.</span><span class="hl-6">_id</span><span class="hl-13">.</span><span class="hl-1">toString</span><span class="hl-13">()</span><span class="hl-4">}</span><span class="hl-3">`</span><span class="hl-2">);</span><br/><span class="hl-2">      </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-3">`Attempt: </span><span class="hl-4">${</span><span class="hl-6">job</span><span class="hl-13">.</span><span class="hl-6">attemptsCount</span><span class="hl-4">}</span><span class="hl-3">`</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

</embedex>
<h4 id="job-handler-options" class="tsd-anchor-link">Job handler options<a href="#job-handler-options" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li><strong><code>name</code></strong> (required): Unique identifier for the job type</li>
<li><strong><code>maxAttempts</code></strong> (optional): Maximum number of retry attempts before marking the job as failed. Default is 10. Uses exponential backoff: 2^attempt seconds between retries</li>
<li><strong><code>perform</code></strong> (required): Async function that executes the job logic
<ul>
<li><code>data</code>: The job payload passed when enqueueing</li>
<li><code>job</code>: Optional metadata about the job execution (id, attempts, timestamps, etc.)</li>
</ul>
</li>
</ul>
<h3 id="registering-jobs" class="tsd-anchor-link">Registering jobs<a href="#registering-jobs" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Register job handlers with the <code>BackgroundJobs</code> instance and assign them to processing groups:</p>
<embedex source="packages/mongo-jobs/examples/usage/registerJobs.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">BackgroundJobs</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;@clipboard-health/mongo-jobs&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">CleanupJob</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobs/cleanupJob&quot;</span><span class="hl-2">;</span><br/><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">EmailJob</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobs/emailJob&quot;</span><span class="hl-2">;</span><br/><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">ReportJob</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobs/reportJob&quot;</span><span class="hl-2">;</span><br/><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">SmsJob</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobs/smsJob&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-4">const</span><span class="hl-2"> </span><span class="hl-9">backgroundJobs</span><span class="hl-2"> = </span><span class="hl-4">new</span><span class="hl-2"> </span><span class="hl-1">BackgroundJobs</span><span class="hl-2">();</span><br/><br/><span class="hl-0">// Register jobs to groups</span><br/><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">register</span><span class="hl-2">(</span><span class="hl-6">EmailJob</span><span class="hl-2">, </span><span class="hl-3">&quot;notifications&quot;</span><span class="hl-2">);</span><br/><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">register</span><span class="hl-2">(</span><span class="hl-6">ReportJob</span><span class="hl-2">, </span><span class="hl-3">&quot;reports&quot;</span><span class="hl-2">);</span><br/><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">register</span><span class="hl-2">(</span><span class="hl-6">CleanupJob</span><span class="hl-2">, </span><span class="hl-3">&quot;maintenance&quot;</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// You can register multiple jobs to the same group</span><br/><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">register</span><span class="hl-2">(</span><span class="hl-6">SmsJob</span><span class="hl-2">, </span><span class="hl-3">&quot;notifications&quot;</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

</embedex>
<p>Groups allow you to:</p>
<ul>
<li>Organize related jobs together</li>
<li>Run dedicated workers for specific job types</li>
<li>Control concurrency per group</li>
<li>Scale different job types independently</li>
</ul>
<h4 id="jobs-with-dependencies" class="tsd-anchor-link">Jobs with dependencies<a href="#jobs-with-dependencies" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>If your job requires dependencies (like services, database connections, etc.) passed through the constructor, you must register an instance instead of the class:</p>
<embedex source="packages/mongo-jobs/examples/usage/registerJobsWithDependencies.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">BackgroundJobs</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;@clipboard-health/mongo-jobs&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">EmailServiceJob</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobs/emailServiceJob&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-4">const</span><span class="hl-2"> </span><span class="hl-9">backgroundJobs</span><span class="hl-2"> = </span><span class="hl-4">new</span><span class="hl-2"> </span><span class="hl-1">BackgroundJobs</span><span class="hl-2">();</span><br/><br/><span class="hl-0">// For jobs with constructor dependencies, register an instance</span><br/><span class="hl-4">const</span><span class="hl-2"> </span><span class="hl-9">emailService</span><span class="hl-2"> = {</span><br/><span class="hl-2">  </span><span class="hl-4">async</span><span class="hl-2"> </span><span class="hl-1">send</span><span class="hl-2">(</span><span class="hl-6">to</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">, </span><span class="hl-6">subject</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">, </span><span class="hl-6">body</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-3">`Sending email to </span><span class="hl-4">${</span><span class="hl-6">to</span><span class="hl-4">}</span><span class="hl-3">: </span><span class="hl-4">${</span><span class="hl-6">subject</span><span class="hl-4">}</span><span class="hl-3"> : </span><span class="hl-4">${</span><span class="hl-6">body</span><span class="hl-4">}</span><span class="hl-3">`</span><span class="hl-2">);</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">};</span><br/><br/><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">register</span><span class="hl-2">(</span><span class="hl-4">new</span><span class="hl-2"> </span><span class="hl-1">EmailServiceJob</span><span class="hl-2">(</span><span class="hl-6">emailService</span><span class="hl-2">), </span><span class="hl-3">&quot;notifications&quot;</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

</embedex>
<p>Example job with dependencies:</p>
<embedex source="packages/mongo-jobs/examples/usage/jobs/emailServiceJob.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> </span><span class="hl-8">type</span><span class="hl-2"> { </span><span class="hl-6">HandlerInterface</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;@clipboard-health/mongo-jobs&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-4">interface</span><span class="hl-2"> </span><span class="hl-10">EmailService</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-1">send</span><span class="hl-2">(</span><span class="hl-6">to</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">, </span><span class="hl-6">subject</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">, </span><span class="hl-6">body</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">): </span><span class="hl-10">Promise</span><span class="hl-2">&lt;</span><span class="hl-10">void</span><span class="hl-2">&gt;;</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-8">export</span><span class="hl-2"> </span><span class="hl-4">interface</span><span class="hl-2"> </span><span class="hl-10">EmailServiceJobData</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">to</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">;</span><br/><span class="hl-2">  </span><span class="hl-6">subject</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">;</span><br/><span class="hl-2">  </span><span class="hl-6">body</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">;</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-8">export</span><span class="hl-2"> </span><span class="hl-4">class</span><span class="hl-2"> </span><span class="hl-10">EmailServiceJob</span><span class="hl-2"> </span><span class="hl-4">implements</span><span class="hl-2"> </span><span class="hl-10">HandlerInterface</span><span class="hl-2">&lt;</span><span class="hl-10">EmailServiceJobData</span><span class="hl-2">&gt; {</span><br/><span class="hl-2">  </span><span class="hl-4">public</span><span class="hl-2"> </span><span class="hl-6">name</span><span class="hl-2"> = </span><span class="hl-3">&quot;EmailServiceJob&quot;</span><span class="hl-2">;</span><br/><span class="hl-2">  </span><span class="hl-4">public</span><span class="hl-2"> </span><span class="hl-6">maxAttempts</span><span class="hl-2"> = </span><span class="hl-11">3</span><span class="hl-2">;</span><br/><br/><span class="hl-2">  </span><span class="hl-4">constructor</span><span class="hl-2">(</span><span class="hl-4">private</span><span class="hl-2"> </span><span class="hl-4">readonly</span><span class="hl-2"> </span><span class="hl-6">emailService</span><span class="hl-2">: </span><span class="hl-10">EmailService</span><span class="hl-2">) {}</span><br/><br/><span class="hl-2">  </span><span class="hl-4">async</span><span class="hl-2"> </span><span class="hl-1">perform</span><span class="hl-2">({ </span><span class="hl-6">to</span><span class="hl-2">, </span><span class="hl-6">subject</span><span class="hl-2">, </span><span class="hl-6">body</span><span class="hl-2"> }: </span><span class="hl-10">EmailServiceJobData</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-4">this</span><span class="hl-2">.</span><span class="hl-6">emailService</span><span class="hl-2">.</span><span class="hl-1">send</span><span class="hl-2">(</span><span class="hl-6">to</span><span class="hl-2">, </span><span class="hl-6">subject</span><span class="hl-2">, </span><span class="hl-6">body</span><span class="hl-2">);</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

</embedex>
<p><strong>Important</strong>: When registering job instances, the library will use the instance directly rather than instantiating the class. This means:</p>
<ul>
<li>The same instance is used for all job executions in this process</li>
<li>Dependencies are shared across all executions</li>
<li>Your job class should be stateless (all state should come from the <code>data</code> parameter)</li>
</ul>
<p><strong>Note</strong>: Even when registering an instance, you can still enqueue jobs using the class, instance, or handler name:</p>
<pre><code class="ts"><span class="hl-0">// All of these work, regardless of whether you registered a class or instance</span><br/><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">enqueue</span><span class="hl-2">(</span><span class="hl-6">EmailServiceJob</span><span class="hl-2">, </span><span class="hl-6">data</span><span class="hl-2">); </span><span class="hl-0">// By class</span><br/><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">enqueue</span><span class="hl-2">(</span><span class="hl-6">emailServiceJobInstance</span><span class="hl-2">, </span><span class="hl-6">data</span><span class="hl-2">); </span><span class="hl-0">// By instance</span><br/><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">enqueue</span><span class="hl-2">(</span><span class="hl-3">&quot;EmailServiceJob&quot;</span><span class="hl-2">, </span><span class="hl-6">data</span><span class="hl-2">); </span><span class="hl-0">// By name</span>
</code><button type="button">Copy</button></pre>

<p>The enqueued class/instance/name is only used to look up the registered handler. The <strong>registered</strong> instance is always used for execution, not the instance passed to <code>enqueue()</code>.</p>
<h3 id="enqueuing-jobs" class="tsd-anchor-link">Enqueuing jobs<a href="#enqueuing-jobs" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Add jobs to the queue for processing:</p>
<embedex source="packages/mongo-jobs/examples/usage/enqueueBasic.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">backgroundJobs</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobsRegistry&quot;</span><span class="hl-2">;</span><br/><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">MyJob</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./myJob&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Basic enqueue</span><br/><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">enqueue</span><span class="hl-2">(</span><span class="hl-6">MyJob</span><span class="hl-2">, {</span><br/><span class="hl-2">  </span><span class="hl-6">userId:</span><span class="hl-2"> </span><span class="hl-3">&quot;123&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">action:</span><span class="hl-2"> </span><span class="hl-3">&quot;process&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

</embedex>
<embedex source="packages/mongo-jobs/examples/usage/enqueueWithOptions.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> </span><span class="hl-8">type</span><span class="hl-2"> { </span><span class="hl-6">ClientSession</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;mongodb&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">backgroundJobs</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobsRegistry&quot;</span><span class="hl-2">;</span><br/><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">MyJob</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./myJob&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-4">declare</span><span class="hl-2"> </span><span class="hl-4">const</span><span class="hl-2"> </span><span class="hl-9">mongoSession</span><span class="hl-2">: </span><span class="hl-10">ClientSession</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Enqueue with options</span><br/><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">enqueue</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-6">MyJob</span><span class="hl-2">,</span><br/><span class="hl-2">  { </span><span class="hl-6">userId:</span><span class="hl-2"> </span><span class="hl-3">&quot;123&quot;</span><span class="hl-2">, </span><span class="hl-6">action:</span><span class="hl-2"> </span><span class="hl-3">&quot;process&quot;</span><span class="hl-2"> },</span><br/><span class="hl-2">  {</span><br/><span class="hl-2">    </span><span class="hl-0">// Schedule for later</span><br/><span class="hl-2">    </span><span class="hl-6">startAt:</span><span class="hl-2"> </span><span class="hl-4">new</span><span class="hl-2"> </span><span class="hl-1">Date</span><span class="hl-2">(</span><span class="hl-3">&quot;2024-12-31T23:59:59Z&quot;</span><span class="hl-2">),</span><br/><br/><span class="hl-2">    </span><span class="hl-0">// Ensure uniqueness (see uniqueness section below)</span><br/><span class="hl-2">    </span><span class="hl-6">unique:</span><span class="hl-2"> </span><span class="hl-3">&quot;user-123-process&quot;</span><span class="hl-2">,</span><br/><br/><span class="hl-2">    </span><span class="hl-0">// Use within a MongoDB transaction</span><br/><span class="hl-2">    </span><span class="hl-6">session:</span><span class="hl-2"> </span><span class="hl-6">mongoSession</span><span class="hl-2">,</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

</embedex>
<embedex source="packages/mongo-jobs/examples/usage/enqueueByName.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">backgroundJobs</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobsRegistry&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Enqueue by job name (when handler is already registered)</span><br/><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">enqueue</span><span class="hl-2">(</span><span class="hl-3">&quot;MyJob&quot;</span><span class="hl-2">, { </span><span class="hl-6">userId:</span><span class="hl-2"> </span><span class="hl-3">&quot;123&quot;</span><span class="hl-2">, </span><span class="hl-6">action:</span><span class="hl-2"> </span><span class="hl-3">&quot;process&quot;</span><span class="hl-2"> });</span>
</code><button type="button">Copy</button></pre>

</embedex>
<h4 id="enqueue-options" class="tsd-anchor-link">Enqueue options<a href="#enqueue-options" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li><strong><code>startAt</code></strong>: Schedule the job to run at a specific time. Default is immediate</li>
<li><strong><code>unique</code></strong>: Ensure only one instance of the job exists (see Job uniqueness section)</li>
<li><strong><code>session</code></strong>: MongoDB session for transactional job creation</li>
</ul>
<h3 id="starting-a-worker" class="tsd-anchor-link">Starting a worker<a href="#starting-a-worker" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Start processing jobs from one or more groups:</p>
<embedex source="packages/mongo-jobs/examples/usage/startWorkerBasic.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">backgroundJobs</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobsRegistry&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Start a worker for specific groups</span><br/><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">start</span><span class="hl-2">([</span><span class="hl-3">&quot;notifications&quot;</span><span class="hl-2">, </span><span class="hl-3">&quot;reports&quot;</span><span class="hl-2">], {</span><br/><span class="hl-2">  </span><span class="hl-6">maxConcurrency:</span><span class="hl-2"> </span><span class="hl-11">20</span><span class="hl-2">,</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

</embedex>
<embedex source="packages/mongo-jobs/examples/usage/startWorkerWithOptions.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">backgroundJobs</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobsRegistry&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Start with all available options</span><br/><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">start</span><span class="hl-2">([</span><span class="hl-3">&quot;notifications&quot;</span><span class="hl-2">], {</span><br/><span class="hl-2">  </span><span class="hl-0">// Maximum concurrent jobs (default: 10)</span><br/><span class="hl-2">  </span><span class="hl-6">maxConcurrency:</span><span class="hl-2"> </span><span class="hl-11">10</span><span class="hl-2">,</span><br/><br/><span class="hl-2">  </span><span class="hl-0">// Time to wait when no jobs available, in ms (default: 10000)</span><br/><span class="hl-2">  </span><span class="hl-6">newJobCheckWaitMS:</span><span class="hl-2"> </span><span class="hl-11">5000</span><span class="hl-2">,</span><br/><br/><span class="hl-2">  </span><span class="hl-0">// Use MongoDB change streams for instant job detection (default: true)</span><br/><span class="hl-2">  </span><span class="hl-6">useChangeStream:</span><span class="hl-2"> </span><span class="hl-4">true</span><span class="hl-2">,</span><br/><br/><span class="hl-2">  </span><span class="hl-0">// Lock timeout for stuck jobs, in ms (default: 600000 = 10 minutes)</span><br/><span class="hl-2">  </span><span class="hl-6">lockTimeoutMS:</span><span class="hl-2"> </span><span class="hl-11">300_000</span><span class="hl-2">,</span><br/><br/><span class="hl-2">  </span><span class="hl-0">// Interval to check for stuck jobs, in ms (default: 60000 = 1 minute)</span><br/><span class="hl-2">  </span><span class="hl-6">unlockJobsIntervalMS:</span><span class="hl-2"> </span><span class="hl-11">30_000</span><span class="hl-2">,</span><br/><br/><span class="hl-2">  </span><span class="hl-0">// Interval to refresh queue list, in ms (default: 30000 = 30 seconds)</span><br/><span class="hl-2">  </span><span class="hl-6">refreshQueuesIntervalMS:</span><span class="hl-2"> </span><span class="hl-11">60_000</span><span class="hl-2">,</span><br/><br/><span class="hl-2">  </span><span class="hl-0">// Exclude specific queues from processing</span><br/><span class="hl-2">  </span><span class="hl-6">exclude:</span><span class="hl-2"> [</span><span class="hl-3">&quot;low-priority-queue&quot;</span><span class="hl-2">],</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

</embedex>
<embedex source="packages/mongo-jobs/examples/usage/stopWorker.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">backgroundJobs</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobsRegistry&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Graceful shutdown</span><br/><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">stop</span><span class="hl-2">(</span><span class="hl-11">30_000</span><span class="hl-2">); </span><span class="hl-0">// Wait up to 30 seconds for jobs to complete</span>
</code><button type="button">Copy</button></pre>

</embedex>
<h4 id="worker-options" class="tsd-anchor-link">Worker options<a href="#worker-options" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li><strong><code>maxConcurrency</code></strong>: Number of jobs to process simultaneously</li>
<li><strong><code>useChangeStream</code></strong>: Enable instant job detection using MongoDB change streams. When <code>true</code>, workers are notified immediately when new jobs are added</li>
<li><strong><code>newJobCheckWaitMS</code></strong>: Fallback polling interval when no jobs are available</li>
<li><strong><code>lockTimeoutMS</code></strong>: Maximum time a job can be locked before being considered stuck</li>
<li><strong><code>unlockJobsIntervalMS</code></strong>: How often to check for and unlock stuck jobs</li>
<li><strong><code>refreshQueuesIntervalMS</code></strong>: How often to refresh the list of queues to consume</li>
<li><strong><code>exclude</code></strong>: Array of queue names to skip processing</li>
</ul>
<h3 id="cron-jobs" class="tsd-anchor-link">Cron jobs<a href="#cron-jobs" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Schedule recurring jobs using cron expressions:</p>
<embedex source="packages/mongo-jobs/examples/usage/cronRegister.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">BackgroundJobs</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;@clipboard-health/mongo-jobs&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">DailyReportJob</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobs/dailyReportJob&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-4">const</span><span class="hl-2"> </span><span class="hl-9">backgroundJobs</span><span class="hl-2"> = </span><span class="hl-4">new</span><span class="hl-2"> </span><span class="hl-1">BackgroundJobs</span><span class="hl-2">();</span><br/><br/><span class="hl-0">// Register a cron job</span><br/><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">registerCron</span><span class="hl-2">(</span><span class="hl-6">DailyReportJob</span><span class="hl-2">, {</span><br/><span class="hl-2">  </span><span class="hl-0">// Group assignment (same as regular registration)</span><br/><span class="hl-2">  </span><span class="hl-6">group:</span><span class="hl-2"> </span><span class="hl-3">&quot;reports&quot;</span><span class="hl-2">,</span><br/><br/><span class="hl-2">  </span><span class="hl-0">// Unique name for this schedule</span><br/><span class="hl-2">  </span><span class="hl-6">scheduleName:</span><span class="hl-2"> </span><span class="hl-3">&quot;daily-report&quot;</span><span class="hl-2">,</span><br/><br/><span class="hl-2">  </span><span class="hl-0">// Cron expression (standard 5-field format)</span><br/><span class="hl-2">  </span><span class="hl-6">cronExpression:</span><span class="hl-2"> </span><span class="hl-3">&quot;0 9 * * *&quot;</span><span class="hl-2">, </span><span class="hl-0">// Every day at 9 AM</span><br/><br/><span class="hl-2">  </span><span class="hl-0">// Optional: timezone for cron evaluation (default: &quot;utc&quot;)</span><br/><span class="hl-2">  </span><span class="hl-6">timeZone:</span><span class="hl-2"> </span><span class="hl-3">&quot;America/New_York&quot;</span><span class="hl-2">,</span><br/><br/><span class="hl-2">  </span><span class="hl-0">// Data to pass to each job execution</span><br/><span class="hl-2">  </span><span class="hl-6">data:</span><span class="hl-2"> { </span><span class="hl-6">reportType:</span><span class="hl-2"> </span><span class="hl-3">&quot;daily&quot;</span><span class="hl-2"> },</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

</embedex>
<embedex source="packages/mongo-jobs/examples/usage/cronRemove.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">backgroundJobs</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobsRegistry&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Remove a cron schedule and its pending jobs</span><br/><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">removeCron</span><span class="hl-2">(</span><span class="hl-3">&quot;daily-report&quot;</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

</embedex>
<h4 id="cron-scheduling-details" class="tsd-anchor-link">Cron scheduling details<a href="#cron-scheduling-details" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li>Uses standard 5-field cron expressions: <code>minute hour day month weekday</code></li>
<li>Automatically enqueues the next job after the current one completes</li>
<li>Updates to cron schedules automatically cancel pending jobs and reschedule</li>
<li>Failed cron jobs are retried according to <code>maxAttempts</code>, but the next scheduled job will still be enqueued</li>
<li>Each scheduled execution is a unique job instance</li>
</ul>
<h4 id="removing-cron-schedules" class="tsd-anchor-link">Removing cron schedules<a href="#removing-cron-schedules" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p><strong>Important</strong>: When you register a cron schedule, it is persisted in the database. Even if you remove the schedule registration from your code, it will continue executing. To stop a cron schedule, you must explicitly remove it using the <code>removeCron</code> API:</p>
<pre><code class="ts"><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">removeCron</span><span class="hl-2">(</span><span class="hl-3">&quot;daily-report&quot;</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<p>This will:</p>
<ul>
<li>Delete the schedule from the database</li>
<li>Cancel all pending jobs that were created by this schedule</li>
<li>Prevent future jobs from being scheduled</li>
</ul>
<h3 id="job-uniqueness" class="tsd-anchor-link">Job uniqueness<a href="#job-uniqueness" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Prevent duplicate jobs from being enqueued or running simultaneously:</p>
<embedex source="packages/mongo-jobs/examples/usage/uniqueSimple.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">ProcessUserJob</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobs/processUserJob&quot;</span><span class="hl-2">;</span><br/><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">backgroundJobs</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobsRegistry&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Simple uniqueness - single unique key for both enqueued and running</span><br/><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">enqueue</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-6">ProcessUserJob</span><span class="hl-2">,</span><br/><span class="hl-2">  { </span><span class="hl-6">userId:</span><span class="hl-2"> </span><span class="hl-3">&quot;123&quot;</span><span class="hl-2"> },</span><br/><span class="hl-2">  {</span><br/><span class="hl-2">    </span><span class="hl-6">unique:</span><span class="hl-2"> </span><span class="hl-3">&quot;process-user-123&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

</embedex>
<h4 id="advanced-uniqueness" class="tsd-anchor-link">Advanced uniqueness<a href="#advanced-uniqueness" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>It's possible to have separate enqueued and running key. When the job is enqueued, the library will
ensure that we can't enqueue another one but once it starts running it switches to its running key so
we can enqueue another one that will wait to be executed until the first one finishes.</p>
<p>An example where this can be useful is recalculating some kind of a cache. We don't want to enqueue more
than one non-running job to not explode number of enqueued jobs. But once it starts running and there is another
trigger that may warrant cache recalculation we want to schedule another one to do another recalculation even
if there is one running, cause we don't know if the current recalculation will include the newest change.</p>
<embedex source="packages/mongo-jobs/examples/usage/uniqueAdvanced.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">ProcessUserJob</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobs/processUserJob&quot;</span><span class="hl-2">;</span><br/><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">backgroundJobs</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobsRegistry&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Advanced uniqueness - separate keys for enqueued vs running states</span><br/><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">enqueue</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-6">ProcessUserJob</span><span class="hl-2">,</span><br/><span class="hl-2">  { </span><span class="hl-6">userId:</span><span class="hl-2"> </span><span class="hl-3">&quot;123&quot;</span><span class="hl-2"> },</span><br/><span class="hl-2">  {</span><br/><span class="hl-2">    </span><span class="hl-6">unique:</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-0">// Only one enqueued job per user</span><br/><span class="hl-2">      </span><span class="hl-6">enqueuedKey:</span><span class="hl-2"> </span><span class="hl-3">&quot;process-user-123&quot;</span><span class="hl-2">,</span><br/><br/><span class="hl-2">      </span><span class="hl-0">// Only one running job per user</span><br/><span class="hl-2">      </span><span class="hl-6">runningKey:</span><span class="hl-2"> </span><span class="hl-3">&quot;process-user-123-running&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">    },</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

</embedex>
<embedex source="packages/mongo-jobs/examples/usage/uniqueMultipleEnqueued.ts">
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">SendEmailJob</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobs/sendEmailJob&quot;</span><span class="hl-2">;</span><br/><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">backgroundJobs</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;./jobsRegistry&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Example: Allow multiple enqueued but only one running</span><br/><span class="hl-8">await</span><span class="hl-2"> </span><span class="hl-6">backgroundJobs</span><span class="hl-2">.</span><span class="hl-1">enqueue</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-6">SendEmailJob</span><span class="hl-2">,</span><br/><span class="hl-2">  { </span><span class="hl-6">userId:</span><span class="hl-2"> </span><span class="hl-3">&quot;123&quot;</span><span class="hl-2">, </span><span class="hl-6">emailType:</span><span class="hl-2"> </span><span class="hl-3">&quot;welcome&quot;</span><span class="hl-2"> },</span><br/><span class="hl-2">  {</span><br/><span class="hl-2">    </span><span class="hl-6">unique:</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-6">enqueuedKey:</span><span class="hl-2"> </span><span class="hl-4">undefined</span><span class="hl-2">, </span><span class="hl-0">// Allow multiple enqueued emails</span><br/><span class="hl-2">      </span><span class="hl-6">runningKey:</span><span class="hl-2"> </span><span class="hl-3">&quot;send-email-123&quot;</span><span class="hl-2">, </span><span class="hl-0">// But only one sending at a time</span><br/><span class="hl-2">    },</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

</embedex>
<h4 id="uniqueness-behavior" class="tsd-anchor-link">Uniqueness behavior<a href="#uniqueness-behavior" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li><strong>Enqueued uniqueness</strong>: Prevents duplicate jobs from being added to the queue. If a job with the same <code>enqueuedKey</code> already exists and hasn't started, the new enqueue returns <code>undefined</code></li>
<li><strong>Running uniqueness</strong>: When a job starts, its unique key transitions from <code>enqueuedKey</code> to <code>runningKey</code>. This prevents multiple instances from running simultaneously</li>
<li>If a duplicate unique key is detected, the operation silently fails and returns <code>undefined</code></li>
<li>Uniqueness is enforced via MongoDB unique index on the <code>uniqueKey</code> field</li>
<li>Cron jobs automatically use unique keys based on schedule name and timestamp</li>
</ul>
<h2 id="observability" class="tsd-anchor-link">Observability<a href="#observability" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="metrics" class="tsd-anchor-link">Metrics<a href="#metrics" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The library automatically reports metrics using StatsD by default. Metrics are reported every 60 seconds for each queue and include:</p>
<ul>
<li><strong><code>background_jobs.queue.scheduled</code></strong> - Number of jobs scheduled for future execution</li>
<li><strong><code>background_jobs.queue.pending</code></strong> - Number of jobs ready to be processed</li>
<li><strong><code>background_jobs.queue.created</code></strong> - Total jobs (scheduled + pending)</li>
<li><strong><code>background_jobs.queue.failed</code></strong> - Number of jobs that exhausted all retry attempts</li>
<li><strong><code>background_jobs.queue.retry</code></strong> - Counter incremented when a job is retried</li>
<li><strong><code>background_jobs.queue.expired</code></strong> - Counter incremented when a job lock expires (stuck jobs)</li>
<li><strong><code>background_jobs.queue.delay</code></strong> - Timing metric for execution delay (time between <code>nextRunAt</code> and actual execution)</li>
</ul>
<p>All metrics are tagged with <code>queue</code> to identify which queue the metric belongs to.</p>
<h4 id="custom-metrics-reporter" class="tsd-anchor-link">Custom metrics reporter<a href="#custom-metrics-reporter" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>You can provide a custom metrics reporter by implementing the <code>MetricsReporter</code> interface:</p>
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">BackgroundJobs</span><span class="hl-2">, </span><span class="hl-8">type</span><span class="hl-2"> </span><span class="hl-6">MetricsReporter</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;@clipboard-health/mongo-jobs&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-4">class</span><span class="hl-2"> </span><span class="hl-10">CustomMetricsReporter</span><span class="hl-2"> </span><span class="hl-4">implements</span><span class="hl-2"> </span><span class="hl-10">MetricsReporter</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-1">gauge</span><span class="hl-2">(</span><span class="hl-6">name</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">, </span><span class="hl-6">value</span><span class="hl-2">: </span><span class="hl-10">number</span><span class="hl-2">, </span><span class="hl-6">tags</span><span class="hl-2">: </span><span class="hl-10">Record</span><span class="hl-2">&lt;</span><span class="hl-10">string</span><span class="hl-2">, </span><span class="hl-10">string</span><span class="hl-2">&gt;): </span><span class="hl-10">void</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-0">// Report gauge metric</span><br/><span class="hl-2">    </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-3">`Gauge: </span><span class="hl-4">${</span><span class="hl-6">name</span><span class="hl-4">}</span><span class="hl-3"> = </span><span class="hl-4">${</span><span class="hl-6">value</span><span class="hl-4">}</span><span class="hl-3">`</span><span class="hl-2">, </span><span class="hl-6">tags</span><span class="hl-2">);</span><br/><span class="hl-2">  }</span><br/><br/><span class="hl-2">  </span><span class="hl-1">increment</span><span class="hl-2">(</span><span class="hl-6">name</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">, </span><span class="hl-6">tags</span><span class="hl-2">: </span><span class="hl-10">Record</span><span class="hl-2">&lt;</span><span class="hl-10">string</span><span class="hl-2">, </span><span class="hl-10">string</span><span class="hl-2">&gt;): </span><span class="hl-10">void</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-0">// Report counter increment</span><br/><span class="hl-2">    </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-3">`Increment: </span><span class="hl-4">${</span><span class="hl-6">name</span><span class="hl-4">}</span><span class="hl-3">`</span><span class="hl-2">, </span><span class="hl-6">tags</span><span class="hl-2">);</span><br/><span class="hl-2">  }</span><br/><br/><span class="hl-2">  </span><span class="hl-1">timing</span><span class="hl-2">(</span><span class="hl-6">name</span><span class="hl-2">: </span><span class="hl-10">string</span><span class="hl-2">, </span><span class="hl-6">value</span><span class="hl-2">: </span><span class="hl-10">number</span><span class="hl-2"> | </span><span class="hl-10">Date</span><span class="hl-2">, </span><span class="hl-6">tags</span><span class="hl-2">: </span><span class="hl-10">Record</span><span class="hl-2">&lt;</span><span class="hl-10">string</span><span class="hl-2">, </span><span class="hl-10">string</span><span class="hl-2">&gt;): </span><span class="hl-10">void</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-0">// Report timing metric</span><br/><span class="hl-2">    </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-3">`Timing: </span><span class="hl-4">${</span><span class="hl-6">name</span><span class="hl-4">}</span><span class="hl-3"> = </span><span class="hl-4">${</span><span class="hl-6">value</span><span class="hl-4">}</span><span class="hl-3">`</span><span class="hl-2">, </span><span class="hl-6">tags</span><span class="hl-2">);</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-4">const</span><span class="hl-2"> </span><span class="hl-9">backgroundJobs</span><span class="hl-2"> = </span><span class="hl-4">new</span><span class="hl-2"> </span><span class="hl-1">BackgroundJobs</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">metricsReporter:</span><span class="hl-2"> </span><span class="hl-4">new</span><span class="hl-2"> </span><span class="hl-1">CustomMetricsReporter</span><span class="hl-2">(),</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<h4 id="statsd-configuration" class="tsd-anchor-link">StatsD configuration<a href="#statsd-configuration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>The default metrics reporter uses the <code>hot-shots</code> StatsD client. You can configure it by passing options:</p>
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">BackgroundJobs</span><span class="hl-2">, </span><span class="hl-6">defaultMetricsReporter</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;@clipboard-health/mongo-jobs&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-4">const</span><span class="hl-2"> </span><span class="hl-9">backgroundJobs</span><span class="hl-2"> = </span><span class="hl-4">new</span><span class="hl-2"> </span><span class="hl-1">BackgroundJobs</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">metricsReporter:</span><span class="hl-2"> </span><span class="hl-1">defaultMetricsReporter</span><span class="hl-2">({</span><br/><span class="hl-2">    </span><span class="hl-6">host:</span><span class="hl-2"> </span><span class="hl-3">&quot;localhost&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">port:</span><span class="hl-2"> </span><span class="hl-11">8125</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">globalTags:</span><span class="hl-2"> { </span><span class="hl-6">env:</span><span class="hl-2"> </span><span class="hl-3">&quot;production&quot;</span><span class="hl-2"> },</span><br/><span class="hl-2">  }),</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<h3 id="opentelemetry-tracing" class="tsd-anchor-link">OpenTelemetry tracing<a href="#opentelemetry-tracing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The library provides built-in OpenTelemetry distributed tracing support. Traces are automatically created for job enqueueing (producer) and execution (consumer), allowing you to track jobs across your distributed system.</p>
<h4 id="trace-spans" class="tsd-anchor-link">Trace spans<a href="#trace-spans" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Three types of spans are created:</p>
<ol>
<li>
<p><strong>Producer spans</strong> (<code>background-jobs.producer</code>) - Created when a job is enqueued</p>
<ul>
<li>Kind: <code>PRODUCER</code></li>
<li>Attributes include: messaging system, operation, destination (handler name), queue name</li>
</ul>
</li>
<li>
<p><strong>Consumer spans</strong> (<code>background-jobs.consumer</code>) - Created when a job is executed</p>
<ul>
<li>Kind: <code>CONSUMER</code></li>
<li>Linked to the producer span for distributed tracing</li>
<li>Attributes include: message ID, handler name, queue, attempt count, timestamps</li>
</ul>
</li>
<li>
<p><strong>Internal spans</strong> (<code>background-jobs.internals</code>) - Created for internal operations</p>
<ul>
<li>Kind: <code>INTERNAL</code></li>
<li>Used for operations like fetching jobs, reporting metrics, etc.</li>
</ul>
</li>
</ol>
<h4 id="setting-up-opentelemetry" class="tsd-anchor-link">Setting up OpenTelemetry<a href="#setting-up-opentelemetry" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>To enable tracing, configure the OpenTelemetry SDK in your application:</p>
<pre><code class="ts"><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">NodeSDK</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;@opentelemetry/sdk-node&quot;</span><span class="hl-2">;</span><br/><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">getNodeAutoInstrumentations</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;@opentelemetry/auto-instrumentations-node&quot;</span><span class="hl-2">;</span><br/><span class="hl-8">import</span><span class="hl-2"> { </span><span class="hl-6">OTLPTraceExporter</span><span class="hl-2"> } </span><span class="hl-8">from</span><span class="hl-2"> </span><span class="hl-3">&quot;@opentelemetry/exporter-trace-otlp-http&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-4">const</span><span class="hl-2"> </span><span class="hl-9">sdk</span><span class="hl-2"> = </span><span class="hl-4">new</span><span class="hl-2"> </span><span class="hl-1">NodeSDK</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">traceExporter:</span><span class="hl-2"> </span><span class="hl-4">new</span><span class="hl-2"> </span><span class="hl-1">OTLPTraceExporter</span><span class="hl-2">({</span><br/><span class="hl-2">    </span><span class="hl-6">url:</span><span class="hl-2"> </span><span class="hl-3">&quot;http://localhost:4318/v1/traces&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  }),</span><br/><span class="hl-2">  </span><span class="hl-6">instrumentations:</span><span class="hl-2"> [</span><span class="hl-1">getNodeAutoInstrumentations</span><span class="hl-2">()],</span><br/><span class="hl-2">});</span><br/><br/><span class="hl-6">sdk</span><span class="hl-2">.</span><span class="hl-1">start</span><span class="hl-2">();</span>
</code><button type="button">Copy</button></pre>

<h4 id="distributed-tracing" class="tsd-anchor-link">Distributed tracing<a href="#distributed-tracing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>When a job is enqueued, trace context is automatically injected into the job data via the <code>_traceHeaders</code> field. When the job is executed, this context is extracted to link the consumer span to the producer span, enabling end-to-end trace visibility.</p>
<pre><code class="text">HTTP Request  Enqueue Job (Producer Span)
                    
              [Job in Queue]
                    
              Execute Job (Consumer Span)  Your Handler
</code><button type="button">Copy</button></pre>

<h2 id="license" class="tsd-anchor-link">License<a href="#license" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>MIT</p>
</section><details class="tsd-panel-group tsd-member-group tsd-accordion" open><summary class="tsd-accordion-summary" data-key="section-Classes"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h2>Classes</h2></summary><dl class="tsd-member-summaries"><dt class="tsd-member-summary" id="backgroundjobs"><span class="tsd-member-summary-name"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Class"><use href="../assets/icons.svg#icon-128"></use></svg><a href="../classes/_clipboard-health_mongo-jobs.BackgroundJobs.html">BackgroundJobs</a><a href="#backgroundjobs" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></span></dt><dd class="tsd-member-summary"></dd></dl></details><details class="tsd-panel-group tsd-member-group tsd-accordion" open><summary class="tsd-accordion-summary" data-key="section-Interfaces"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h2>Interfaces</h2></summary><dl class="tsd-member-summaries"><dt class="tsd-member-summary" id="backgroundjobtype"><span class="tsd-member-summary-name"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Interface"><use href="../assets/icons.svg#icon-256"></use></svg><a href="../interfaces/_clipboard-health_mongo-jobs.BackgroundJobType.html">BackgroundJobType</a><a href="#backgroundjobtype" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></span></dt><dd class="tsd-member-summary"></dd><dt class="tsd-member-summary" id="constructoroptions"><span class="tsd-member-summary-name"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Interface"><use href="../assets/icons.svg#icon-256"></use></svg><a href="../interfaces/_clipboard-health_mongo-jobs.ConstructorOptions.html">ConstructorOptions</a><a href="#constructoroptions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></span></dt><dd class="tsd-member-summary"></dd><dt class="tsd-member-summary" id="handlerinterface"><span class="tsd-member-summary-name"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Interface"><use href="../assets/icons.svg#icon-256"></use></svg><a href="../interfaces/_clipboard-health_mongo-jobs.HandlerInterface.html">HandlerInterface</a><a href="#handlerinterface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></span></dt><dd class="tsd-member-summary"></dd></dl></details></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#clipboard-healthmongo-jobs"><span>@clipboard-<wbr/>health/mongo-<wbr/>jobs</span></a><ul><li><a href="#features"><span>Features</span></a></li><li><a href="#installation"><span>Installation</span></a></li><li><a href="#quick-start"><span>Quick <wbr/>Start</span></a></li><li><ul><li><a href="#1-define-a-job-handler"><span>1. <wbr/>Define a job handler</span></a></li><li><a href="#2-create-a-service-and-register-handlers"><span>2. <wbr/>Create a service and register handlers</span></a></li><li><a href="#3-enqueue-jobs"><span>3. <wbr/>Enqueue jobs</span></a></li><li><a href="#4-start-the-worker"><span>4. <wbr/>Start the worker</span></a></li></ul></li><li><a href="#usage"><span>Usage</span></a></li><li><ul><li><a href="#creating-a-job"><span>Creating a job</span></a></li><li><ul><li><a href="#job-handler-options"><span>Job handler options</span></a></li></ul></li><li><a href="#registering-jobs"><span>Registering jobs</span></a></li><li><ul><li><a href="#jobs-with-dependencies"><span>Jobs with dependencies</span></a></li></ul></li><li><a href="#enqueuing-jobs"><span>Enqueuing jobs</span></a></li><li><ul><li><a href="#enqueue-options"><span>Enqueue options</span></a></li></ul></li><li><a href="#starting-a-worker"><span>Starting a worker</span></a></li><li><ul><li><a href="#worker-options"><span>Worker options</span></a></li></ul></li><li><a href="#cron-jobs"><span>Cron jobs</span></a></li><li><ul><li><a href="#cron-scheduling-details"><span>Cron scheduling details</span></a></li><li><a href="#removing-cron-schedules"><span>Removing cron schedules</span></a></li></ul></li><li><a href="#job-uniqueness"><span>Job uniqueness</span></a></li><li><ul><li><a href="#advanced-uniqueness"><span>Advanced uniqueness</span></a></li><li><a href="#uniqueness-behavior"><span>Uniqueness behavior</span></a></li></ul></li></ul></li><li><a href="#observability"><span>Observability</span></a></li><li><ul><li><a href="#metrics"><span>Metrics</span></a></li><li><ul><li><a href="#custom-metrics-reporter"><span>Custom metrics reporter</span></a></li><li><a href="#statsd-configuration"><span>Stats<wbr/>D configuration</span></a></li></ul></li><li><a href="#opentelemetry-tracing"><span>Open<wbr/>Telemetry tracing</span></a></li><li><ul><li><a href="#trace-spans"><span>Trace spans</span></a></li><li><a href="#setting-up-opentelemetry"><span>Setting up <wbr/>Open<wbr/>Telemetry</span></a></li><li><a href="#distributed-tracing"><span>Distributed tracing</span></a></li></ul></li></ul></li><li><a href="#license"><span>License</span></a></li></ul><details open class="tsd-accordion tsd-page-navigation-section"><summary class="tsd-accordion-summary" data-key="section-Classes"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Classes</summary><div><a href="#backgroundjobs"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Class"><use href="../assets/icons.svg#icon-128"></use></svg><span>Background<wbr/>Jobs</span></a></div></details><details open class="tsd-accordion tsd-page-navigation-section"><summary class="tsd-accordion-summary" data-key="section-Interfaces"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Interfaces</summary><div><a href="#backgroundjobtype"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Interface"><use href="../assets/icons.svg#icon-256"></use></svg><span>Background<wbr/>Job<wbr/>Type</span></a><a href="#constructoroptions"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Interface"><use href="../assets/icons.svg#icon-256"></use></svg><span>Constructor<wbr/>Options</span></a><a href="#handlerinterface"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Interface"><use href="../assets/icons.svg#icon-256"></use></svg><span>Handler<wbr/>Interface</span></a></div></details></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">core-utils</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
